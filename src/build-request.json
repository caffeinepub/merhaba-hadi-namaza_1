{
  "kind": "build_request",
  "title": "Fix AndroidPush prayer-times payload schema (dailyPrayers/weeklyPrayers as JSON objects) and document Android parsing + periodic notification updates",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-3",
      "text": "Update the web-to-AndroidPush payload so `dailyPrayers` and `weeklyPrayers` are JSON arrays of objects (not strings), where each element is exactly `{ \"name\": string, \"time\": string, \"timeMillis\": number }`, and ensure the payload is sent via `window.AndroidPush.sendPrayerTimes(JSON.stringify(jsonData))` without causing Android-side `JSONObject`/`JSONArray` parsing crashes.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Android tarafında PersistentNotificationService, JSON içindeki `dailyPrayers` ve `weeklyPrayers` alanlarını bekliyor.",
          "Her eleman `{ \"name\": \"...\", \"time\": \"...\", \"timeMillis\": ... }` formatında bir JSON nesnesi olmalı.",
          "Çökme sebebi: web tarafı düz string gönderiyor, Android ise JSONObject bekliyor.",
          "Web tarafında `window.AndroidPush.sendPrayerTimes(JSON.stringify(jsonData))` çağrısında `jsonData` içine hem günlük hem haftalık vakitleri JSON nesneleri halinde koy."
        ]
      },
      "acceptanceCriteria": [
        "`frontend/src/features/home/useAndroidPushPrayerTimes.ts` no longer constructs `dailyPrayers: string[]` and `weeklyPrayers: string[]`; both are built as arrays of objects with keys `name`, `time`, `timeMillis`.",
        "For daily payload: `dailyPrayers` contains today's prayer entries as `{name,time,timeMillis}` objects, with `time` in HH:MM and `timeMillis` representing the same local-day timestamp in milliseconds.",
        "For weekly payload: `weeklyPrayers` contains upcoming prayer entries for the next 7 days as `{name,time,timeMillis}` objects (or another explicitly documented ordering), and every entry includes valid `timeMillis` > 0.",
        "`sendPrayerTimesToAndroidPush(...)` is called with the new schema and still sends a single JSON string to `AndroidPush.sendPrayerTimes` (or fallback `AndroidPush.send`).",
        "If required data to compute `timeMillis` is missing/invalid, the hook does not send malformed payloads (fails safely without throwing)."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Update the AndroidPush TypeScript declarations and web bridge validation to match the new schema where `dailyPrayers` and `weeklyPrayers` are arrays of objects `{name,time,timeMillis}` (not formatted strings), and keep backward-compatible bridge method fallback behavior (`sendPrayerTimes` then `send`).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Android tarafında PersistentNotificationService, JSON içindeki `dailyPrayers` ve `weeklyPrayers` alanlarını bekliyor.",
          "Her eleman `{ \"name\": \"...\", \"time\": \"...\", \"timeMillis\": ... }` formatında bir JSON nesnesi olmalı."
        ]
      },
      "acceptanceCriteria": [
        "`frontend/src/androidPushBridge.d.ts` documentation and types describe `dailyPrayers` and `weeklyPrayers` as arrays of `{ name: string; time: string; timeMillis: number }`.",
        "`frontend/src/utils/androidBridge.ts` validates that `dailyPrayers` and `weeklyPrayers` are arrays of objects with `name` (string), `time` (HH:MM string), and `timeMillis` (number > 0) before sending.",
        "Bridge sending still attempts `window.AndroidPush.sendPrayerTimes(jsonPayload)` first and falls back to `window.AndroidPush.send(jsonPayload)` if needed.",
        "No runtime exceptions are thrown from the validation layer when running in a non-Android browser environment."
      ]
    },
    {
      "id": "REQ-5",
      "text": "Add developer-facing documentation that includes (1) an example JavaScript snippet that builds the correct `jsonData` structure (including daily + weekly arrays of `{name,time,timeMillis}`) and calls `window.AndroidPush.sendPrayerTimes(JSON.stringify(jsonData))`, and (2) an example Kotlin snippet showing how Android should parse the JSON (`JSONObject` -> `JSONArray` -> `JSONObject`), store/retrieve it from SharedPreferences, compute the next upcoming prayer using `timeMillis`, and periodically refresh a persistent notification while the app UI is not open.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Bana hem web tarafı için doğru JSON örneğini hem de Android tarafında nasıl parse edileceğini göster.",
          "Çıktı: - Web tarafı için örnek JavaScript kodu ... - Android tarafı için Kotlin kodu (JSONArray içinden JSONObject okuyarak sıradaki vakti bulup bildirimi güncelleyen).",
          "Android tarafı bu JSON’u SharedPreferences’a kaydedip servis içinde periyodik olarak bildirimi güncellesin."
        ]
      },
      "acceptanceCriteria": [
        "`frontend/docs/android-webview-template.md` (or a new markdown doc under `frontend/docs/`) contains an explicit example payload JSON showing `dailyPrayers` and `weeklyPrayers` as arrays of objects with `name`, `time`, `timeMillis`.",
        "The documentation includes a copy-pasteable JavaScript example that demonstrates computing/setting `timeMillis` per prayer and sending it through `AndroidPush.sendPrayerTimes`.",
        "The documentation includes a copy-pasteable Kotlin example that: reads the JSON string from SharedPreferences; parses `dailyPrayers` and/or `weeklyPrayers` via `JSONArray` and `getJSONObject(i)`; selects the next prayer by smallest `timeMillis` greater than `System.currentTimeMillis()`; and shows a periodic update loop approach for updating an ongoing notification.",
        "All documentation text intended for developers is written in English."
      ]
    }
  ],
  "constraints": [
    "Do not add any backend (Motoko) endpoints or URL-based fetching for prayer times; the integration must remain WebView JavaScript bridge based (AndroidPush).",
    "Do not modify any files under `frontend/src/hooks/useInternetIdentity.ts`, `frontend/src/hooks/useInternetIdentity.tsx`, `frontend/src/hooks/useActor.ts`, `frontend/src/main.tsx`, or `frontend/src/components/ui` (immutable paths).",
    "Keep the AndroidPush bridge method name behavior compatible with existing Android implementations by preserving the `sendPrayerTimes` then `send` fallback."
  ],
  "nonGoals": [
    "Implement or ship Android Studio/Kotlin source code inside this repository (only provide documentation/code samples).",
    "Add new user-facing UI features unrelated to the AndroidPush payload schema fix.",
    "Add real-time/background web execution; the web app will not be responsible for running timers when the app is closed."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}